<div [ngClass]="{'ease-in-out transition-all duration-500 opacity-0 -translate-x-full': post.animateDelete}">
  <mat-card class="bg-amber-50">
    <mat-card-header>
      <div class="flex justify-between w-full">

        <!-- Avatar and username -->
        <div class="flex gap-4 cursor-pointer" (click)="navigateToUser(post.username)">

          <div mat-card-avatar class="bg-cover" style="background-image: url({{post.profileImg}});"
            *ngIf="post.profileImg"></div>
          <div mat-card-avatar class="flex justify-center items-center bg-indigo-950"><mat-icon
              class="text-green-50">person</mat-icon></div>
          <mat-card-title>{{post.username}}</mat-card-title>
        </div>

        <!-- Options/Info (create date, edit date and follow/follow and report actions) -->
        <div>
          <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Options" matTooltipClass="tooltip"
            matTooltipPosition="above"><mat-icon class="icon dark:text-whitesmoke">more_horiz</mat-icon></button>
          <mat-menu #menu="matMenu">
            <div mat-menu-item>
              <p class="text-sm dark:text-whitesmoke">{{post.createTime}}</p>
            </div>
            <div mat-menu-item *ngIf="post.editTime">
              <p class="text-sm dark:text-whitesmoke">{{post.editTime}}</p>
            </div>

            <!-- follow / unfollow  -->
            <!-- {{post | json}} -->
            <app-follow viewTemplate="textView" [followIdentity]="{
                loggedInUserId: 'this should be the logged in user id - may not be required',
                ownerUserId: post.id,
                ownerUsername: post.username}"></app-follow>

            <ng-container *ngIf="canEditPost(post)">
              <button mat-menu-item  
                  (click)="openEditPostModal(post)">
                  <span class="font-medium text-slate-900 dark:text-slate-100">Edit</span>
              </button>
            </ng-container>
            
            <button mat-menu-item>
              <span (click)="reportPost(post.id)" class="font-medium text-red-600">Report</span>
            </button>
          </mat-menu>
        </div>
      </div>
    </mat-card-header>

    <!-- Media types -->
    <div *ngIf="post.mediaType">
      <img mat-card-image src="{{post.s3Url}}" *ngIf="post.mediaType.split('/')[0] == 'image'">
      <video *ngIf="post.mediaType.split('/')[0] == 'video'" controls>
        <source [src]="post.s3Url" type="video/mp4">
        <source [src]="post.s3Url" type="video/ogg">
        Your browser does not support the video tag.
      </video>
    </div>
    <mat-card-content>
      <p class="!mt-3" *ngIf="post.message">
        {{post.message}}
      </p>
    </mat-card-content>

    <!-- Tags -->
    <mat-card-footer>
      <ul class="m-4 flex gap-2 flex-wrap">
        <li class="cursor-pointer" *ngFor="let tag of post.tags" (click)="navigateToTag(tag.id)">
          #{{tag.name}}
        </li>
      </ul>
    </mat-card-footer>

    <!-- Actions (like, dislike, share post, and open chat) -->
    <mat-card-actions class="flex justify-between">

      <div class="flex gap-4">
        Likes: {{post.upVotes}}
        <mat-icon class="icon dark:text-whitesmoke" matTooltip="Like" matTooltipClass="tooltip" matTooltipPosition="above"
          [ngClass]="{ 'disabled': !thumbsUpEnabled }" (click)="likePost(post.id)">thumb_up</mat-icon>
        Dislikes: {{post.downVotes}}
        <mat-icon class="icon dark:text-whitesmoke" matTooltip="Dislike" matTooltipClass="tooltip" matTooltipPosition="above"
          [ngClass]="{ 'disabled': !thumbsDownEnabled }" (click)="dislikePost(post.id)">thumb_down</mat-icon>
      </div>
      <div class="flex gap-4">
        <mat-icon class="icon" matTooltip="Like" matTooltipClass="tooltip" matTooltipPosition="above"
          (click)="likePost(post.id)">bookmark_border</mat-icon>
        <mat-icon class="icon dark:text-whitesmoke" matTooltip="Share" matTooltipClass="tooltip" matTooltipPosition="above"
          (click)="sharePost()">share</mat-icon>
        <mat-icon class="icon dark:text-whitesmoke" matTooltip="Comment" matTooltipClass="tooltip" matTooltipPosition="above"
          (click)="toggleChat()">chat</mat-icon>
      </div>
    </mat-card-actions>

    <!-- Chat -->
    <div *ngIf="isChatOpen">
      <mat-divider></mat-divider>

      <div class="py-4 px-2">
        <!-- Comment form -->
        <form [formGroup]="commentForm" (ngSubmit)="onCommentSubmit()">
          <div *ngIf="!isGifComponentOpen">
            <!-- Comment entity-->
            <div
              class="group transition-all ease-in-out duration-200 flex flex-col p-3 border-solid border-[1px] border-slate-700 rounded-xl">
              <!-- Message -->
              <textarea
                class="flex-grow text-slate-950 bg-transparent outline-none placeholder:text-slate-950/60 group-focus-within:placeholder:text-slate-950/30"
                rows="1" maxlength="500" placeholder="Make your comment" formControlName="comment"></textarea>
              <!-- Gif preview -->
              <div class="relative mt-5 rounded-md overflow-hidden" *ngIf="chosenGif">
                <div
                  class="flex justify-center items-center absolute top-2 right-2 p-2 bg-slate-950/50 text-white rounded-full cursor-pointer transition-all ease-in-out duration-300 hover:bg-slate-950/70"
                  (click)="removeGif()">
                  <mat-icon>close</mat-icon>
                </div>
                <img class="w-full" [src]="chosenGif" alt="Gif image">
              </div>
            </div>


            <!-- Comment action options -->
            <div class="flex gap-1 pt-1">
              <div
                class="flex justify-center items-center p-1 rounded-full cursor-pointer transition-all ease-in-out duration-300 hover:bg-slate-950/20"
                (click)="toggleGifComponent()">
                <mat-icon class="scale-[0.80]">gif</mat-icon>
              </div>
              <div
                class="flex justify-center items-center p-1 rounded-full cursor-pointer transition-all ease-in-out duration-300 hover:bg-slate-950/20"
                (click)="toggleEmojiMart()">
                <mat-icon class="scale-[0.80]">tag_faces</mat-icon>
              </div>

              <button type="submit">Reply</button>
            </div>
          </div>

          <!-- Gif component -->
          <div *ngIf="isGifComponentOpen">
            <app-gif (gifChosenEvent)="addGif($event)" (closeGifComponentEvent)="toggleGifComponent()"></app-gif>
          </div>

          <!-- Emoji mart -->
          <div class="pt-2 px-2" [ngClass]="{'-translate-y-[calc(100%+30px)]': chosenGif}" *ngIf="isEmojiMartOpen">
            <div class="fixed top-0 left-0 w-screen h-screen z-30" (click)="toggleEmojiMart()"></div>
            <div class="relative z-40 w-min">
              <emoji-mart title="Pick your emoji" set="facebook" [showPreview]="false" [emojiTooltip]="true"
                (emojiClick)="addEmoji($event.emoji.native)" *ngIf="isEmojiMartOpen"></emoji-mart>
            </div>
          </div>
        </form>
      </div>

      <!-- No comments response -->
      <div class="flex flex-col justify-center items-center gap-5 h-[300px]"
        *ngIf="!post.comments || (post.comments && post.comments.length == 0)">
        <mat-icon class="text-slate-700 scale-[1.7] dark: text-whitesmoke">chat</mat-icon>
        <p class="font-medium text-lg dark:text-whitesmoke">Be the first to comment!</p>
      </div>

      <!-- Displays comments -->
      <ul class="flex flex-col p-4 gap-3" *ngIf="post.comments && post.comments.length > 0">
        <li class="flex gap-3" *ngFor="let comment of post.comments">
          <div mat-card-avatar class="m-0 bg-cover"
            style="background-image: url('https://images.unsplash.com/photo-1517849845537-4d257902454a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=435&q=80');">
          </div>
          <div class="flex flex-col gap-2 p-2 border-[1px] border-solid border-slate-700 rounded-lg">
            <p class="m-0 font-semibold">{{comment.username}}</p>
            <p class="m-0">{{comment.comment}}</p>
          </div>
        </li>
      </ul>
    </div>
  </mat-card>
</div>
